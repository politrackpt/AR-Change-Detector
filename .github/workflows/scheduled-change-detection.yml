name: üîç Scheduled Change Detection

on:
  schedule:
    # 8 AM Lisbon Time (UTC+1 in winter, UTC+2 in summer)
    - cron: '0 7 * * *'   # Winter
    - cron: '0 6 * * *'   # Summer
    # 4 PM Lisbon Time
    - cron: '0 15 * * *'  # Winter
    - cron: '0 14 * * *'  # Summer
  workflow_dispatch:

env:
  NODE_VERSION: '22'
  TARGET_REPO: 'politrackpt/Open-Data-Retrieval'

jobs:
  detect-changes:
    runs-on: ubuntu-latest

    steps:
    - name: üîß Checkout Repository
      uses: actions/checkout@v4

    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: üì¶ Install Dependencies
      run: npm ci

    - name: üé≠ Install Playwright Browsers
      run: npx playwright install firefox

    - name: üîç Run Change Detection
      run: npm run default
      continue-on-error: true

    - name: üìã Check if Changes Detected
      id: check-changes
      run: |
        if [ -f "data/change-report.json" ]; then
          if [ -s "data/change-report.json" ] && ! grep -q '^{}$' "data/change-report.json"; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "üìä Changes detected - triggering Open-Data-Retrieval"
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No changes detected - skipping trigger"
          fi
        else
          echo "changes_detected=false" >> $GITHUB_OUTPUT
          echo "‚ùå No change-report.json file generated"
        fi

    - name: üöÄ Trigger Open-Data-Retrieval
      if: steps.check-changes.outputs.changes_detected == 'true'
      run: |
        ENCODED=$(base64 -w 0 data/change-report.json)
        curl -X POST \
          -H "Authorization: token ${{ secrets.CROSS_REPO_PAT }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/politrackpt/Open-Data-Retrieval/dispatches \
          -d @- <<EOF
        {
          "event_type": "ar-changes-detected",
          "client_payload": {
            "changes": "$ENCODED",
            "source_repo": "${{ github.repository }}",
            "source_run_id": "${{ github.run_id }}"
          }
        }
        EOF

    - name: üíæ Commit Updated Hashes
      if: always()
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"

        git add data/hashes.json

        if git diff --cached --quiet; then
          echo "üü¢ No changes to commit."
        else
          git commit -m "üîÑ Update hashes.json after change detection [skip ci]"
          git push origin ${{ github.ref_name }}
        fi

    - name: ‚úÖ Finished
      run: echo "Workflow completed"